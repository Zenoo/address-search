class AddressSearch{constructor(e,t={},i){this._input=e instanceof Element?e:document.querySelector(e),this._errors=[],this._input||this._errors.push("AddressSearch: "+("string"==typeof e?"The selector `"+e+"` didn't match any element.":"The element you provided was undefined")),this._input&&this._input.classList.contains("address-search-input")&&this._errors.push("AddressSearch: The element has already been initialized."),this._errors.length?this._errors.forEach(e=>{console.warn(e)}):(this.uniqueId=document.querySelectorAll(".address-search[data-unique-id]").length+1,this._fetchPredictions=new google.maps.places.AutocompleteService,this._fetchPlace=new google.maps.places.PlacesService(document.createElement("div")),this._token="",this._usedTokens=[],this._economizer={},this._lure=this._input.cloneNode(!0),this._onSelect=[],this._onPredict=[],this._onError=[],this._parameters=t,this._delay=i,this._lastKeypress=null,this._timeout=null,this._apiFields=["address_component","adr_address","alt_id","formatted_address","geometry","icon","id","name","business_status","photo","place_id","plus_code","scope","type","url","utc_offset_minutes","vicinity"],this.value={},this._components=Object.entries(this._parameters).reduce((e,[t,i])=>{const s=document.querySelector(i);return s?e[t]=s:console.warn("The selector `"+i+"` didn't match any element."),e},{}),this._generateToken(),this._build(),this._listen())}_build(){this._wrapper=document.createElement("div"),this._wrapper.classList.add("address-search"),this._wrapper.setAttribute("data-unique-id",this.uniqueId),this._input.parentNode.insertBefore(this._wrapper,this._input),this._typeahead=document.createElement("input"),this._typeahead.setAttribute("class",this._input.getAttribute("class")),this._typeahead.setAttribute("tabindex",-1),this._typeahead.classList.add("address-search-typeahead");let e=this._typeahead.cloneNode(!0);e.classList.add("lure"),this._wrapper.appendChild(e),this._wrapper.appendChild(this._typeahead),this._lure.classList.add("address-search-lure"),this._lure.setAttribute("tabindex",-1),this._wrapper.appendChild(this._lure),this._input.classList.add("address-search-input"),this._input.removeAttribute("id"),this._input.removeAttribute("name"),this._wrapper.appendChild(this._input),this._predictions=document.createElement("ul"),this._predictions.classList.add("address-search-predictions"),this._wrapper.appendChild(this._predictions),Object.values(this._components).forEach(e=>{let t=e.cloneNode(!0);t.removeAttribute("id"),t.removeAttribute("class"),t.removeAttribute("name"),t.classList.add("address-search-lure"),t.setAttribute("data-refer-to",this.uniqueId),t.setAttribute("tabindex",-1),e.parentNode.insertBefore(t,e)})}_listen(){this._input.addEventListener("input",()=>{if(clearTimeout(this._timeout),this._lure.value=this._input.value,this._input.value.length)if(this._input.value=this._capitalize(this._input.value),this._lure.value=this._input.value,this._delay&&(this._typeahead.value=""),this._economizer[this._input.value]){this._predictions.innerHTML=this._economizer[this._input.value],this._predictions.firstElementChild.getAttribute("data-place-description").startsWith(this._input.value)?this._typeahead.value=this._predictions.firstElementChild.getAttribute("data-place-description"):this._typeahead.value="",this._togglePredictions("on");for(let e of this._onPredict)e.call(this,this._input.value,this._predictions)}else this._delay?this._timeout=setTimeout(()=>{this._getPredictions()},this._delay):this._getPredictions();else this._typeahead.value="",this._togglePredictions("off");this.value={}}),this._input.addEventListener("keydown",e=>{let t=e.keyCode||e.which;9!=t&&13!=t||(e.preventDefault(),this._input.value.length?this._select(this._predictions.firstElementChild.getAttribute("data-place-id")):this._input.blur())}),this._input.addEventListener("blur",()=>{0===Object.keys(this.value).length&&this.value.constructor===Object&&setTimeout(()=>{this._input.value="",this._lure.value=this._input.value,this._typeahead.value="",this._togglePredictions("off")},1)}),this._predictions.addEventListener("mousedown",e=>{this._predictions.classList.add("clicked")}),this._predictions.addEventListener("click",e=>{if(this._predictions.classList.remove("clicked"),e.target&&("LI"==e.target.nodeName||"SPAN"==e.target.nodeName)){let t=e.target.closest("li");this._select(t.getAttribute("data-place-id"))}})}_getPredictions(){this._fetchPredictions.getPlacePredictions({input:this._input.value,sessiontoken:this._token},(e,t)=>{if(this._resetPredictions(),t==google.maps.places.PlacesServiceStatus.OK){for(let t of e){let e=document.createElement("li");e.setAttribute("data-place-id",t.place_id),e.setAttribute("data-place-description",this._capitalize(t.description).replace(/"/g,"'"));let i=document.createElement("span");if(i.innerText=t.structured_formatting.main_text,e.appendChild(i),t.structured_formatting.secondary_text){let i=document.createElement("span");i.innerText=t.structured_formatting.secondary_text,e.appendChild(i)}this._predictions.appendChild(e)}this._economizer[this._input.value]=this._predictions.innerHTML,this._capitalize(e[0].description.substring(0,e[0].matched_substrings[0].length))==this._input.value?this._typeahead.value=this._capitalize(e[0].description):this._typeahead.value="",this._togglePredictions("on");for(let e of this._onPredict)e.call(this,this._input.value,this._predictions)}else if("ZERO_RESULTS"==t){let e=document.createElement("li");e.classList.add("empty-results"),e.innerText="No address found",this._predictions.appendChild(e),this._typeahead.value=""}else console.log(t)})}_resetPredictions(){this._predictions.innerHTML=""}_togglePredictions(e){e?"on"==e?this._predictions.classList.add("shown"):this._predictions.classList.remove("shown"):this._predictions.classList.toggle("shown")}_capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}_select(e,t=!0){return new Promise((i,s)=>{this._fetchPlace.getDetails({placeId:e,fields:this._apiFields,sessiontoken:this._token},(e,r)=>{if(r==google.maps.places.PlacesServiceStatus.OK){if(this._generateToken(),this._togglePredictions("off"),this._resetPredictions(),this.value=e,this._input.value=e.formatted_address,this._lure.value=this._input.value,this._typeahead.value="",Object.entries(this._components).forEach(([e,t])=>{let i=e.endsWith("_short")?this._getPlaceComponent(e.slice(0,-6),!0):this._getPlaceComponent(e);t.value=i,t.previousElementSibling.value=i,t.readOnly=!!t.value.length}),this._input.blur(),t)for(let e of this._onSelect)e.call(this,this.value);i()}else{console.log(r);for(let e of this._onError)e.call(this,r);s(r)}})})}_getPlaceComponent(e,t){let i=this.value.address_components.filter(t=>t.types.includes(e));return i.length?t?i[0].short_name:i[0].long_name:""}_generateToken(){let e=this._token;for(;""==e||this._usedTokens.includes(e);)e=(Math.random()+1).toString(36).substring(7);this._token=e,this._usedTokens.push(this._token)}onSelect(e){return this._errors.length||this._onSelect.push(e),this}offSelect(){return this._errors.length||(this._onSelect=[]),this}onPredict(e){return this._errors.length||this._onPredict.push(e),this}offPredict(){return this._errors.length||(this._onPredict=[]),this}onError(e){return this._errors.length||this._onError.push(e),this}offError(){return this._errors.length||(this._onError=[]),this}setValue(e,t=!0){this._errors.length||("string"==typeof e?this._fetchPredictions.getPlacePredictions({input:e},(e,i)=>{if(i==google.maps.places.PlacesServiceStatus.OK){let i=e[0];this._select(i.place_id,t)}else{console.log(i);for(let e of this._onError)e.call(this,i)}}):(this.value=e,this._input.value=e.formatted_address,this._lure.value=this._input.value,this._typeahead.value=""))}setPlace(e,t=!0){return this._errors.length?Promise.resolve():this._select(e,t)}reset(){return this._errors.length||(this.value={},this._input.value="",this._lure.value="",this._typeahead.value=""),this}refreshService(){return this._errors.length||(this._fetchPredictions=new google.maps.places.AutocompleteService,this._fetchPlace=new google.maps.places.PlacesService(document.createElement("div")),this._economizer={}),this}useService(e){return this._errors.length||(this._fetchPredictions=e.maps.places.AutocompleteService(),this._fetchPlace=e.maps.places.PlacesService(document.createElement("div")),this._economizer={}),this}setFields(e){return this._apiFields=e,this}destroy(){if(!this._errors.length){this._lure.id&&this._input.setAttribute("id",this._lure.id),this._lure.getAttribute("name")&&this._input.setAttribute("name",this._lure.getAttribute("name")),this._input.parentNode.parentNode.insertBefore(this._input,this._wrapper),this._wrapper.remove(),this._input.classList.remove("address-search-input"),document.querySelectorAll('.address-search-lure[data-refer-to="'+this.uniqueId+'"]').forEach(e=>e.remove());let e=this._input.cloneNode(!0);this._input.parentNode.replaceChild(e,this._input)}}static destroy(e){let t=document.querySelector(e);if(t){let e=t.nextElementSibling;if(e&&e.matches(".address-search-input")){let i=e.closest(".address-search[data-unique-id]").getAttribute("data-unique-id");document.querySelectorAll('.address-search-lure[data-refer-to="'+i+'"]').forEach(e=>e.remove()),t.id&&e.setAttribute("id",t.id),t.getAttribute("name")&&e.setAttribute("name",t.getAttribute("name")),e.parentNode.parentNode.insertBefore(e,e.parentNode),e.nextElementSibling.remove(),e.classList.remove("address-search-input");let s=e.cloneNode(!0);e.parentNode.replaceChild(s,e)}}}}