class AddressSearch{constructor(target,parameters={},delay){this._input=target instanceof Element?target:document.querySelector(target),this._errors=[],this._input||this._errors.push("AddressSearch: "+("string"==typeof target?"The selector `"+target+"` didn't match any element.":"The element you provided was undefined")),this._input&&this._input.classList.contains("address-search-input")&&this._errors.push("AddressSearch: The element has already been initialized."),this._errors.length?this._errors.forEach(error=>{console.warn(error)}):(this.uniqueId=document.querySelectorAll(".address-search[data-unique-id]").length+1,this._fetchPredictions=new google.maps.places.AutocompleteService,this._fetchPlace=new google.maps.places.PlacesService(document.createElement("div")),this._token="",this._usedTokens=[],this._economizer={},this._lure=this._input.cloneNode(!0),this._onSelect=[],this._onPredict=[],this._parameters=parameters,this._delay=delay,this._lastKeypress=null,this._timeout=null,this.value={},this._components=Object.entries(this._parameters).reduce((acc,[component,target])=>(acc[component]=document.querySelector(target),acc),{}),this._generateToken(),this._build(),this._listen())}_build(){this._wrapper=document.createElement("div"),this._wrapper.classList.add("address-search"),this._wrapper.setAttribute("data-unique-id",this.uniqueId),this._input.parentNode.insertBefore(this._wrapper,this._input),this._typeahead=document.createElement("input"),this._typeahead.setAttribute("class",this._input.getAttribute("class")),this._typeahead.classList.add("address-search-typeahead");let typeaheadLure=this._typeahead.cloneNode(!0);typeaheadLure.classList.add("lure"),this._wrapper.appendChild(typeaheadLure),this._wrapper.appendChild(this._typeahead),this._lure.classList.add("address-search-lure"),this._wrapper.appendChild(this._lure),this._input.classList.add("address-search-input"),this._input.removeAttribute("id"),this._input.removeAttribute("name"),this._wrapper.appendChild(this._input),this._predictions=document.createElement("ul"),this._predictions.classList.add("address-search-predictions"),this._wrapper.appendChild(this._predictions),Object.values(this._components).forEach(element=>{let lure=element.cloneNode(!0);lure.removeAttribute("id"),lure.removeAttribute("class"),lure.classList.add("address-search-lure"),lure.setAttribute("data-refer-to",this.uniqueId),element.parentNode.insertBefore(lure,element)})}_listen(){this._input.addEventListener("input",()=>{if(clearTimeout(this._timeout),this._lure.value=this._input.value,this._input.value.length)if(this._input.value=this._capitalize(this._input.value),this._lure.value=this._input.value,this._delay&&(this._typeahead.value=""),this._economizer[this._input.value]){this._predictions.innerHTML=this._economizer[this._input.value],this._predictions.firstElementChild.getAttribute("data-place-description").startsWith(this._input.value)?this._typeahead.value=this._predictions.firstElementChild.getAttribute("data-place-description"):this._typeahead.value="",this._togglePredictions("on");for(let callback of this._onPredict)callback.call(this,this._input.value,this._predictions)}else this._delay?this._timeout=setTimeout(()=>{this._getPredictions()},this._delay):this._getPredictions();else this._typeahead.value="",this._togglePredictions("off");this.value={}}),this._input.addEventListener("keydown",e=>{let key=e.keyCode||e.which;9!=key&&13!=key||(e.preventDefault(),this._input.value.length?this._select(this._predictions.firstElementChild.getAttribute("data-place-id")):this._input.blur())}),this._input.addEventListener("blur",()=>{0===Object.keys(this.value).length&&this.value.constructor===Object&&setTimeout(()=>{this._input.value="",this._lure.value=this._input.value,this._typeahead.value="",this._togglePredictions("off")},1)}),this._predictions.addEventListener("mousedown",e=>{this._predictions.classList.add("clicked")}),this._predictions.addEventListener("click",e=>{if(this._predictions.classList.remove("clicked"),e.target&&("LI"==e.target.nodeName||"SPAN"==e.target.nodeName)){let li=e.target.closest("li");this._select(li.getAttribute("data-place-id"))}})}_getPredictions(){this._fetchPredictions.getPlacePredictions({input:this._input.value,sessiontoken:this._token},(predictions,status)=>{if(this._resetPredictions(),status==google.maps.places.PlacesServiceStatus.OK){for(let prediction of predictions){let li=document.createElement("li");li.setAttribute("data-place-id",prediction.place_id),li.setAttribute("data-place-description",this._capitalize(prediction.description).replace(/"/g,"'"));let mainText=document.createElement("span");if(mainText.innerText=prediction.structured_formatting.main_text,li.appendChild(mainText),prediction.structured_formatting.secondary_text){let secondaryText=document.createElement("span");secondaryText.innerText=prediction.structured_formatting.secondary_text,li.appendChild(secondaryText)}this._predictions.appendChild(li)}this._economizer[this._input.value]=this._predictions.innerHTML,this._capitalize(predictions[0].description.substring(0,predictions[0].matched_substrings[0].length))==this._input.value?this._typeahead.value=this._capitalize(predictions[0].description):this._typeahead.value="",this._togglePredictions("on");for(let callback of this._onPredict)callback.call(this,this._input.value,this._predictions)}else if("ZERO_RESULTS"==status){let li=document.createElement("li");li.classList.add("empty-results"),li.innerText="No address found",this._predictions.appendChild(li),this._typeahead.value=""}else console.log(status)})}_resetPredictions(){this._predictions.innerHTML=""}_togglePredictions(state){state?"on"==state?this._predictions.classList.add("shown"):this._predictions.classList.remove("shown"):this._predictions.classList.toggle("shown")}_capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1)}_select(placeId,triggerCallbacks=!0){return new Promise((resolve,reject)=>{this._fetchPlace.getDetails({placeId:placeId,sessiontoken:this._token},(place,status)=>{if(status==google.maps.places.PlacesServiceStatus.OK){if(this._generateToken(),this._togglePredictions("off"),this._resetPredictions(),this.value=place,this._input.value=place.formatted_address,this._lure.value=this._input.value,this._typeahead.value="",Object.entries(this._components).forEach(([component,element])=>{let value=component.endsWith("_short")?this._getPlaceComponent(component.slice(0,-6),!0):this._getPlaceComponent(component);element.value=value,element.previousElementSibling.value=value,element.readOnly=!!element.value.length}),this._input.blur(),triggerCallbacks)for(let callback of this._onSelect)callback.call(this,this.value);resolve()}else console.log(status),reject(status)})})}_getPlaceComponent(component,isShort){let target=this.value.address_components.filter(c=>c.types.includes(component));return target.length?isShort?target[0].short_name:target[0].long_name:""}_generateToken(){let newToken=this._token;for(;""==newToken||this._usedTokens.includes(newToken);)newToken=(Math.random()+1).toString(36).substring(7);this._token=newToken,this._usedTokens.push(this._token)}onSelect(callback){return this._errors.length||this._onSelect.push(callback),this}offSelect(){return this._errors.length||(this._onSelect=[]),this}onPredict(callback){return this._errors.length||this._onPredict.push(callback),this}offPredict(){return this._errors.length||(this._onPredict=[]),this}setValue(value,triggerCallbacks=!0){this._errors.length||("string"==typeof value?this._fetchPredictions.getPlacePredictions({input:value},(predictions,status)=>{if(status==google.maps.places.PlacesServiceStatus.OK){let prediction=predictions[0];this._select(prediction.place_id,triggerCallbacks)}else console.log(status)}):(this.value=value,this._input.value=value.formatted_address,this._lure.value=this._input.value,this._typeahead.value=""))}setPlace(place_id,triggerCallbacks=!0){return this._errors.length?Promise.resolve():this._select(place_id,triggerCallbacks)}reset(){return this._errors.length||(this.value={},this._input.value="",this._lure.value="",this._typeahead.value=""),this}refreshService(){return this._errors.length||(this._fetchPredictions=new google.maps.places.AutocompleteService,this._fetchPlace=new google.maps.places.PlacesService(document.createElement("div")),this._economizer={}),this}useService(googleService){return this._errors.length||(this._fetchPredictions=googleService.maps.places.AutocompleteService(),this._fetchPlace=googleService.maps.places.PlacesService(document.createElement("div")),this._economizer={}),this}destroy(){if(!this._errors.length){this._lure.id&&this._input.setAttribute("id",this._lure.id),this._lure.getAttribute("name")&&this._input.setAttribute("name",this._lure.getAttribute("name")),this._input.parentNode.parentNode.insertBefore(this._input,this._wrapper),this._wrapper.remove(),this._input.classList.remove("address-search-input"),document.querySelectorAll('.address-search-lure[data-refer-to="'+this.uniqueId+'"]').forEach(lure=>lure.remove());let cleanInput=this._input.cloneNode(!0);this._input.parentNode.replaceChild(cleanInput,this._input)}}static destroy(selector){let lure=document.querySelector(selector),element=lure.parentNode.querySelector(".address-search-input"),id=element.closest(".address-search[data-unique-id]").getAttribute("data-unique-id");document.querySelectorAll('.address-search-lure[data-refer-to="'+id+'"]').forEach(lure=>lure.remove()),lure.id&&element.setAttribute("id",lure.id),lure.getAttribute("name")&&element.setAttribute("name",lure.getAttribute("name")),element.parentNode.parentNode.insertBefore(element,element.parentNode),element.nextElementSibling.remove(),element.classList.remove("address-search-input");let cleanInput=element.cloneNode(!0);element.parentNode.replaceChild(cleanInput,element)}}