"use strict";require("core-js/modules/es6.array.is-array.js");require("core-js/modules/es6.symbol.js");require("core-js/modules/es6.string.iterator.js");require("core-js/modules/es6.array.iterator.js");require("core-js/modules/web.dom.iterable.js");require("core-js/modules/es6.function.name.js");require("core-js/modules/es6.array.from.js");require("core-js/modules/es6.array.reduce.js");require("core-js/modules/es7.object.entries.js");require("core-js/modules/es6.array.for-each.js");require("core-js/modules/es7.object.values.js");require("core-js/modules/es6.string.starts-with.js");require("core-js/modules/es6.object.keys.js");require("core-js/modules/es6.regexp.replace.js");require("core-js/modules/es6.array.slice.js");require("core-js/modules/es6.object.to-string.js");require("core-js/modules/es6.promise.js");require("core-js/modules/es6.string.ends-with.js");require("core-js/modules/es6.array.filter.js");require("core-js/modules/es6.string.includes.js");require("core-js/modules/es7.array.includes.js");require("core-js/modules/es6.date.to-string.js");require("core-js/modules/es6.regexp.to-string.js");require("core-js/modules/es6.object.define-property.js");function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e2){throw _e2},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o)},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e3){didErr=true;err=_e3},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]()}finally{if(didErr)throw err}}}}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _iterableToArrayLimit(arr,i){var _i=arr==null?null:typeof Symbol!=="undefined"&&arr[Symbol.iterator]||arr["@@iterator"];if(_i==null)return;var _arr=[];var _n=true;var _d=false;var _s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var AddressSearch=function(){function AddressSearch(target){var parameters=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var delay=arguments.length>2?arguments[2]:undefined;_classCallCheck(this,AddressSearch);this._input=target instanceof Element?target:document.querySelector(target);this._errors=[];if(!this._input){this._errors.push("AddressSearch: "+(typeof target=="string"?"The selector `"+target+"` didn't match any element.":"The element you provided was undefined"))}if(this._input&&this._input.classList.contains("address-search-input")){this._errors.push("AddressSearch: The element has already been initialized.")}if(!this._errors.length){this.uniqueId=document.querySelectorAll(".address-search[data-unique-id]").length+1;this._fetchPredictions=new google.maps.places.AutocompleteService;this._fetchPlace=new google.maps.places.PlacesService(document.createElement("div"));this._token="";this._usedTokens=[];this._economizer={};this._lure=this._input.cloneNode(true);this._onSelect=[];this._onPredict=[];this._onError=[];this._parameters=parameters;this._delay=delay;this._lastKeypress=null;this._timeout=null;this._apiFields=["address_component","adr_address","alt_id","formatted_address","geometry","icon","id","name","business_status","photo","place_id","plus_code","scope","type","url","utc_offset_minutes","vicinity"];this.value={};this._components=Object.entries(this._parameters).reduce(function(acc,_ref){var _ref2=_slicedToArray(_ref,2),component=_ref2[0],target=_ref2[1];var targetElement=document.querySelector(target);if(targetElement){acc[component]=targetElement}else{console.warn("The selector `"+target+"` didn't match any element.")}return acc},{});this._generateToken();this._build();this._listen()}else{this._errors.forEach(function(error){console.warn(error)})}}_createClass(AddressSearch,[{key:"_build",value:function _build(){var _this=this;this._wrapper=document.createElement("div");this._wrapper.classList.add("address-search");this._wrapper.setAttribute("data-unique-id",this.uniqueId);this._input.parentNode.insertBefore(this._wrapper,this._input);this._typeahead=document.createElement("input");this._typeahead.setAttribute("class",this._input.getAttribute("class"));this._typeahead.setAttribute("tabindex",-1);this._typeahead.classList.add("address-search-typeahead");var typeaheadLure=this._typeahead.cloneNode(true);typeaheadLure.classList.add("lure");this._wrapper.appendChild(typeaheadLure);this._wrapper.appendChild(this._typeahead);this._lure.classList.add("address-search-lure");this._lure.setAttribute("tabindex",-1);this._wrapper.appendChild(this._lure);this._input.classList.add("address-search-input");this._input.removeAttribute("id");this._input.removeAttribute("name");this._wrapper.appendChild(this._input);this._predictions=document.createElement("ul");this._predictions.classList.add("address-search-predictions");this._wrapper.appendChild(this._predictions);Object.values(this._components).forEach(function(element){var lure=element.cloneNode(true);lure.removeAttribute("id");lure.removeAttribute("class");lure.removeAttribute("name");lure.classList.add("address-search-lure");lure.setAttribute("data-refer-to",_this.uniqueId);lure.setAttribute("tabindex",-1);element.parentNode.insertBefore(lure,element)})}},{key:"_listen",value:function _listen(){var _this2=this;this._input.addEventListener("input",function(){clearTimeout(_this2._timeout);_this2._lure.value=_this2._input.value;if(_this2._input.value.length){_this2._input.value=_this2._capitalize(_this2._input.value);_this2._lure.value=_this2._input.value;if(_this2._delay){_this2._typeahead.value=""}if(_this2._economizer[_this2._input.value]){_this2._predictions.innerHTML=_this2._economizer[_this2._input.value];if(_this2._predictions.firstElementChild.getAttribute("data-place-description").startsWith(_this2._input.value)){_this2._typeahead.value=_this2._predictions.firstElementChild.getAttribute("data-place-description")}else{_this2._typeahead.value=""}_this2._togglePredictions("on");var _iterator=_createForOfIteratorHelper(_this2._onPredict),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var callback=_step.value;callback.call(_this2,_this2._input.value,_this2._predictions)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else{if(_this2._delay){_this2._timeout=setTimeout(function(){_this2._getPredictions()},_this2._delay)}else{_this2._getPredictions()}}}else{_this2._typeahead.value="";_this2._togglePredictions("off")}_this2.value={}});this._input.addEventListener("keydown",function(e){var key=e.keyCode||e.which;if(key==9||key==13){e.preventDefault();if(_this2._input.value.length)_this2._select(_this2._predictions.firstElementChild.getAttribute("data-place-id"));else _this2._input.blur()}});this._input.addEventListener("blur",function(){if(Object.keys(_this2.value).length===0&&_this2.value.constructor===Object){setTimeout(function(){_this2._input.value="";_this2._lure.value=_this2._input.value;_this2._typeahead.value="";_this2._togglePredictions("off")},1)}});this._predictions.addEventListener("mousedown",function(e){_this2._predictions.classList.add("clicked")});this._predictions.addEventListener("click",function(e){_this2._predictions.classList.remove("clicked");if(e.target&&(e.target.nodeName=="LI"||e.target.nodeName=="SPAN")){var li=e.target.closest("li");_this2._select(li.getAttribute("data-place-id"))}})}},{key:"_getPredictions",value:function _getPredictions(){var _this3=this;this._fetchPredictions.getPlacePredictions({input:this._input.value,sessiontoken:this._token},function(predictions,status){_this3._resetPredictions();if(status==google.maps.places.PlacesServiceStatus.OK){var _iterator2=_createForOfIteratorHelper(predictions),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var prediction=_step2.value;var li=document.createElement("li");li.setAttribute("data-place-id",prediction.place_id);li.setAttribute("data-place-description",_this3._capitalize(prediction.description).replace(/"/g,"'"));var mainText=document.createElement("span");mainText.innerText=prediction.structured_formatting.main_text;li.appendChild(mainText);if(prediction.structured_formatting.secondary_text){var secondaryText=document.createElement("span");secondaryText.innerText=prediction.structured_formatting.secondary_text;li.appendChild(secondaryText)}_this3._predictions.appendChild(li)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}_this3._economizer[_this3._input.value]=_this3._predictions.innerHTML;if(_this3._capitalize(predictions[0].description.substring(0,predictions[0].matched_substrings[0].length))==_this3._input.value){_this3._typeahead.value=_this3._capitalize(predictions[0].description)}else{_this3._typeahead.value=""}_this3._togglePredictions("on");var _iterator3=_createForOfIteratorHelper(_this3._onPredict),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var callback=_step3.value;callback.call(_this3,_this3._input.value,_this3._predictions)}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}else{if(status=="ZERO_RESULTS"){var _li=document.createElement("li");_li.classList.add("empty-results");_li.innerText="No address found";_this3._predictions.appendChild(_li);_this3._typeahead.value=""}else{console.log(status)}}})}},{key:"_resetPredictions",value:function _resetPredictions(){this._predictions.innerHTML=""}},{key:"_togglePredictions",value:function _togglePredictions(state){if(state){if(state=="on")this._predictions.classList.add("shown");else this._predictions.classList.remove("shown")}else this._predictions.classList.toggle("shown")}},{key:"_capitalize",value:function _capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1)}},{key:"_select",value:function _select(placeId){var _this4=this;var triggerCallbacks=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return new Promise(function(resolve,reject){_this4._fetchPlace.getDetails({placeId:placeId,fields:_this4._apiFields,sessiontoken:_this4._token},function(place,status){if(status==google.maps.places.PlacesServiceStatus.OK){_this4._generateToken();_this4._togglePredictions("off");_this4._resetPredictions();_this4.value=place;_this4._input.value=place.formatted_address;_this4._lure.value=_this4._input.value;_this4._typeahead.value="";Object.entries(_this4._components).forEach(function(_ref3){var _ref4=_slicedToArray(_ref3,2),component=_ref4[0],element=_ref4[1];var value=component.endsWith("_short")?_this4._getPlaceComponent(component.slice(0,-6),true):_this4._getPlaceComponent(component);element.value=value;element.previousElementSibling.value=value;element.readOnly=!!element.value.length});_this4._input.blur();if(triggerCallbacks){var _iterator4=_createForOfIteratorHelper(_this4._onSelect),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var callback=_step4.value;callback.call(_this4,_this4.value)}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}resolve()}else{console.log(status);var _iterator5=_createForOfIteratorHelper(_this4._onError),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _callback=_step5.value;_callback.call(_this4,status)}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}reject(status)}})})}},{key:"_getPlaceComponent",value:function _getPlaceComponent(component,isShort){var target=this.value.address_components.filter(function(c){return c.types.includes(component)});if(target.length){return isShort?target[0].short_name:target[0].long_name}else return""}},{key:"_generateToken",value:function _generateToken(){var newToken=this._token;while(newToken==""||this._usedTokens.includes(newToken)){newToken=(Math.random()+1).toString(36).substring(7)}this._token=newToken;this._usedTokens.push(this._token)}},{key:"onSelect",value:function onSelect(callback){if(!this._errors.length)this._onSelect.push(callback);return this}},{key:"offSelect",value:function offSelect(){if(!this._errors.length)this._onSelect=[];return this}},{key:"onPredict",value:function onPredict(callback){if(!this._errors.length)this._onPredict.push(callback);return this}},{key:"offPredict",value:function offPredict(){if(!this._errors.length)this._onPredict=[];return this}},{key:"onError",value:function onError(callback){if(!this._errors.length)this._onError.push(callback);return this}},{key:"offError",value:function offError(){if(!this._errors.length)this._onError=[];return this}},{key:"setValue",value:function setValue(value){var _this5=this;var triggerCallbacks=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(!this._errors.length){if(typeof value==="string"){this._fetchPredictions.getPlacePredictions({input:value},function(predictions,status){if(status==google.maps.places.PlacesServiceStatus.OK){var prediction=predictions[0];_this5._select(prediction.place_id,triggerCallbacks)}else{console.log(status);var _iterator6=_createForOfIteratorHelper(_this5._onError),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var callback=_step6.value;callback.call(_this5,status)}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}})}else{this.value=value;this._input.value=value.formatted_address;this._lure.value=this._input.value;this._typeahead.value=""}}}},{key:"setPlace",value:function setPlace(place_id){var triggerCallbacks=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(!this._errors.length){return this._select(place_id,triggerCallbacks)}else{return Promise.resolve()}}},{key:"reset",value:function reset(){if(!this._errors.length){this.value={};this._input.value="";this._lure.value="";this._typeahead.value=""}return this}},{key:"refreshService",value:function refreshService(){if(!this._errors.length){this._fetchPredictions=new google.maps.places.AutocompleteService;this._fetchPlace=new google.maps.places.PlacesService(document.createElement("div"));this._economizer={}}return this}},{key:"useService",value:function useService(googleService){if(!this._errors.length){this._fetchPredictions=googleService.maps.places.AutocompleteService();this._fetchPlace=googleService.maps.places.PlacesService(document.createElement("div"));this._economizer={}}return this}},{key:"setFields",value:function setFields(fieldList){this._apiFields=fieldList;return this}},{key:"destroy",value:function destroy(){if(!this._errors.length){if(this._lure.id)this._input.setAttribute("id",this._lure.id);if(this._lure.getAttribute("name"))this._input.setAttribute("name",this._lure.getAttribute("name"));this._input.parentNode.parentNode.insertBefore(this._input,this._wrapper);this._wrapper.remove();this._input.classList.remove("address-search-input");document.querySelectorAll(".address-search-lure[data-refer-to=\""+this.uniqueId+"\"]").forEach(function(lure){return lure.remove()});var cleanInput=this._input.cloneNode(true);this._input.parentNode.replaceChild(cleanInput,this._input)}}}],[{key:"destroy",value:function destroy(selector){var lure=document.querySelector(selector);if(lure){var element=lure.nextElementSibling;if(element&&element.matches(".address-search-input")){var id=element.closest(".address-search[data-unique-id]").getAttribute("data-unique-id");document.querySelectorAll(".address-search-lure[data-refer-to=\""+id+"\"]").forEach(function(lure){return lure.remove()});if(lure.id)element.setAttribute("id",lure.id);if(lure.getAttribute("name"))element.setAttribute("name",lure.getAttribute("name"));element.parentNode.parentNode.insertBefore(element,element.parentNode);element.nextElementSibling.remove();element.classList.remove("address-search-input");var cleanInput=element.cloneNode(true);element.parentNode.replaceChild(cleanInput,element)}}}}]);return AddressSearch}();
